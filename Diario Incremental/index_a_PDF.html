<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Mi Diario Incremental</title>
  <style>
    body { font-family: sans-serif; max-width: 700px; margin: auto; padding: 20px; }
    textarea { width: 100%; height: 200px; }
    button { margin-top: 10px; padding: 10px; margin-right: 10px; }
    #contador { margin-top: 10px; font-weight: bold; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <h1>Mi Diario Incremental</h1>
  <textarea id="entrada" placeholder="Escribe aquí tu entrada..."></textarea>
  <br>
  <button onclick="guardarEntrada()">Guardar entrada</button>
  <button onclick="compilarDia()">Compilar día</button>
  <button onclick="compilarMes()">Compilar mes</button>
  <button onclick="exportarPDF()">Exportar a PDF</button>
  <button onclick="nuevoMes()">Nuevo Mes</button>
  <div id="contador">Palabras hoy: 0 | Mes: 0</div>

  <script>
    const entrada = document.getElementById("entrada");
    const contador = document.getElementById("contador");

    function getFecha() {
      const hoy = new Date();
      return hoy.toISOString().split("T")[0]; // YYYY-MM-DD
    }

    function getMes() {
      const hoy = new Date();
      return hoy.toISOString().slice(0, 7); // YYYY-MM
    }

    function guardarEntrada() {
      const texto = entrada.value.trim();
      if (texto === "") return;
      const fecha = getFecha();
      const hora = new Date().toTimeString().split(" ")[0].replace(/:/g, "-");
      const clave = `${fecha}_${hora}`;
      localStorage.setItem(clave, texto);
      entrada.value = "";
      alert("Entrada guardada");
      actualizarContadores();
    }

    function compilarDia() {
      const fecha = getFecha();
      let claves = [];

      Object.keys(localStorage).forEach(clave => {
        if (clave.startsWith(fecha)) {
          claves.push(clave);
        }
      });

      claves.sort(); // orden cronológico

      let entradas = claves.map(clave => {
        const hora = clave.split("_")[1].replace(/-/g, ":");
        return `[${hora}]\n${localStorage.getItem(clave)}`;
      }).join("\n\n");

      descargarArchivo(`${fecha}_diario.txt`, entradas);
    }

    function compilarMes() {
      const mes = getMes();
      let claves = [];

      Object.keys(localStorage).forEach(clave => {
        if (clave.startsWith(mes)) {
          claves.push(clave);
        }
      });

      claves.sort(); // orden cronológico

      let entradas = claves.map(clave => {
        const hora = clave.split("_")[1].replace(/-/g, ":");
        const fecha = clave.split("_")[0];
        return `[${fecha} ${hora}]\n${localStorage.getItem(clave)}`;
      }).join("\n\n");

      descargarArchivo(`${mes}_diario.txt`, entradas);
    }

    function exportarPDF() {
      const mes = getMes();
      let claves = [];

      Object.keys(localStorage).forEach(clave => {
        if (clave.startsWith(mes)) {
          claves.push(clave);
        }
      });

      claves.sort(); // orden cronológico

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      let y = 10;

      claves.forEach(clave => {
        const hora = clave.split("_")[1].replace(/-/g, ":");
        const fecha = clave.split("_")[0];
        const texto = `[${fecha} ${hora}]\n${localStorage.getItem(clave)}\n\n`;

        const lineas = doc.splitTextToSize(texto, 180);
        if (y + lineas.length * 7 > 280) {
          doc.addPage();
          y = 10;
        }
        doc.text(lineas, 10, y);
        y += lineas.length * 7;
      });

      doc.save(`${mes}_diario.pdf`);
    }

    function nuevoMes() {
      const mes = getMes();
      const confirmar = confirm("¿Estás seguro de que quieres empezar un nuevo mes? Se borrarán todas las entradas actuales.");

      if (!confirmar) return;

      Object.keys(localStorage).forEach(clave => {
        if (clave.startsWith(mes)) {
          localStorage.removeItem(clave);
        }
      });

      alert("Entradas del mes borradas. ¡Listo para comenzar de nuevo!");
      actualizarContadores();
    }

    function descargarArchivo(nombre, contenido) {
      const blob = new Blob([contenido], { type: "text/plain;charset=utf-8" });
      const enlace = document.createElement("a");
      enlace.href = URL.createObjectURL(blob);
      enlace.download = nombre;
      enlace.click();
    }

    function actualizarContadores() {
      const hoy = getFecha();
      const mes = getMes();
      let palabrasHoy = 0;
      let palabrasMes = 0;

      Object.keys(localStorage).forEach(clave => {
        const texto = localStorage.getItem(clave);
        if (clave.startsWith(hoy)) palabrasHoy += contarPalabras(texto);
        if (clave.startsWith(mes)) palabrasMes += contarPalabras(texto);
      });

      contador.textContent = `Palabras hoy: ${palabrasHoy} | Mes: ${palabrasMes}`;
    }

    function contarPalabras(texto) {
      return texto.trim().split(/\s+/).filter(p => p).length;
    }

    actualizarContadores();
  </script>
</body>
</html>
